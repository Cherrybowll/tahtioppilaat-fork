{% extends "layout.html" %}

{% block title %}
My Bibliography Manager
{% endblock %}

{% block body %}
<h2>My Bibliography Manager</h2>

<div>
  <p>Manage your scientific references with ease. Select your preferred input method below.</p>
</div>

<div style="display: flex; gap: 40px; margin-top: 20px;">
  <!-- Left Column - Input Forms -->
  <div style="flex: 0 0 400px;">
    <form action="/create_reference" method="post" id="referenceForm">
      <!-- DOI Section -->
      <details style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
        <summary style="cursor: pointer; padding: 8px; font-weight: bold; user-select: none; " name="add_by_doi">
          Option 1: Add by DOI
        </summary>
        <div style="margin-top: 15px;">
          <label for="doi">DOI:</label><br>
          <input 
            type="text" 
            id="doi" 
            name="doi" 
            placeholder="Enter the DOI here..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
        </div>
      </details>

      <!-- Article Section -->
      <details style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
        <summary style="cursor: pointer; padding: 8px; font-weight: bold; user-select: none;" name="add_article">
          Option 2: Add Article
        </summary>
        <div style="margin-top: 15px;">
          <label for="article_author">Author:</label><br>
          <input 
            type="text" 
            id="article_author" 
            name="article_author" 
            placeholder="Enter the author(s) here..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="article_title">Title:</label><br>
          <input 
            type="text" 
            id="article_title" 
            name="article_title" 
            placeholder="Enter the title here..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="article_journal">Journal:</label><br>
          <input 
            type="text" 
            id="article_journal" 
            name="article_journal" 
            placeholder="Enter the journal name..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="article_year">Year:</label><br>
          <input 
            type="number" 
            id="article_year" 
            name="article_year" 
            placeholder="Enter publication year..." 
            min="1800"
            max="2024"
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
        </div>
      </details>

      <!-- Inproceedings Section -->
      <details style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
        <summary style="cursor: pointer; padding: 8px; font-weight: bold; user-select: none;" name="add_conference_paper">
          Option 3: Add Conference Paper
        </summary>
        <div style="margin-top: 15px;">
          <label for="inproceeding_author">Author:</label><br>
          <input 
            type="text" 
            id="inproceeding_author" 
            name="inproceeding_author" 
            placeholder="Enter the author(s) here..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="inproceeding_title">Title:</label><br>
          <input 
            type="text" 
            id="inproceeding_title" 
            name="inproceeding_title" 
            placeholder="Enter the title here..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="inproceeding_book_title">Book Title (Conference Proceedings):</label><br>
          <input 
            type="text" 
            id="inproceeding_book_title" 
            name="inproceeding_book_title" 
            placeholder="Enter the conference proceedings name..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="inproceeding_year">Year:</label><br>
          <input 
            type="number" 
            id="inproceeding_year" 
            name="inproceeding_year" 
            placeholder="Enter publication year..." 
            min="1800"
            max="2024"
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
        </div>
      </details>

      <!-- Book Section -->
      <details style="border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
        <summary style="cursor: pointer; padding: 8px; font-weight: bold; user-select: none;" name="add_book">
          Option 4: Add Book
        </summary>
        <div style="margin-top: 15px;">
          <label for="book_author">Author:</label><br>
          <input 
            type="text" 
            id="book_author" 
            name="book_author" 
            placeholder="Enter the author(s) here..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="book_title">Title:</label><br>
          <input 
            type="text" 
            id="book_title" 
            name="book_title" 
            placeholder="Enter the title here..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="book_book_title">Book_Title:</label><br>
          <input 
            type="text" 
            id="book_book_title" 
            name="book_book_title" 
            placeholder="Enter the title here..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="book_publisher">Publisher:</label><br>
          <input 
            type="text" 
            id="book_publisher" 
            name="book_publisher" 
            placeholder="Enter the publisher name..." 
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
          <br><br>
          <label for="book_year">Year:</label><br>
          <input 
            type="number" 
            id="book_year" 
            name="book_year" 
            placeholder="Enter publication year..." 
            min="1800"
            max="2024"
            style="width: 300px; padding: 8px; margin-top: 5px;"
          >
        </div>
      </details>

      <button 
        type="submit" 
        style="margin-top: 20px; margin-left: 10px; padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;"
        onclick="return true"
      >
        Add Reference
      </button>
    </form>
  </div>

<!-- Right Column - Display References -->
  <div style="flex: 1; max-width: 800px;">
    <div style="margin-top: 30px;">
      <h3>Articles:</h3>
      <ul style="list-style: none; padding: 0;">
        {% for article in articles %}
          <li id="reference-article-{{article.id}}"
              data-doi="{{article.article}}"
              style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <span>{{article}}</span>
            <div>
              <button onclick="editReference('article', {{article.id}})" style="padding: 5px 10px; margin-right: 5px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
              <button onclick="deleteReference('article', {{article.id}})" style="padding: 5px 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
            </div>
          </li>
        {% endfor %}
      </ul>

      <!-- Repeat similar structure for other reference types -->
      <h3>Conference Papers:</h3>
      <ul style="list-style: none; padding: 0;">
        {% for inproceeding in inproceedings %}
          <li id="reference-inproceeding-{{inproceeding.id}}"
              data-doi="{{inproceeding.inproceeding}}"
              style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <span>{{inproceeding}}</span>
            <div>
              <button onclick="editReference('inproceeding', {{inproceeding.id}})" style="padding: 5px 10px; margin-right: 5px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
              <button onclick="deleteReference('inproceeding', {{inproceeding.id}})" style="padding: 5px 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
            </div>
          </li>
        {% endfor %}
      </ul>

      <h3>Books:</h3>
      <ul style="list-style: none; padding: 0;">
        {% for book in books %}
          <li id="reference-book-{{book.id}}"
              data-doi="{{book.book}}"
              style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <span>{{book}}</span>
            <div>
              <button onclick="editReference('book', {{book.id}})" style="padding: 5px 10px; margin-right: 5px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
              <button onclick="deleteReference('book', {{book.id}})" style="padding: 5px 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
            </div>
          </li>
        {% endfor %}
      </ul>

      <h3>DOIs:</h3>
      <ul style="list-style: none; padding: 0;">
        {% for doi in dois %}
          <li id="reference-doi-{{doi.id}}"
              data-doi="{{doi.doi}}"
              style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <span>{{doi}}</span>
            <div>
              <button onclick="editReference('doi', {{doi.id}})" style="padding: 5px 10px; margin-right: 5px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
              <button onclick="deleteReference('doi', {{doi.id}})" style="padding: 5px 10px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
            </div>
          </li>
        {% endfor %}
      </ul>

    </div>
  </div>
</div>

<script>

// Add event listeners to ensure only one section is open at a time
document.addEventListener('DOMContentLoaded', function() {
    const detailsElements = document.querySelectorAll('details');
    
    detailsElements.forEach(details => {
        details.addEventListener('click', (e) => {
            if (e.target.tagName === 'SUMMARY') {
                detailsElements.forEach(otherDetails => {
                    if (otherDetails !== details) {
                        otherDetails.removeAttribute('open');
                    }
                });
            }
        });
    });
});


document.addEventListener('DOMContentLoaded', function() {
    const detailsElements = document.querySelectorAll('details');
    
    detailsElements.forEach(details => {
        details.addEventListener('click', (e) => {
            if (e.target.tagName === 'SUMMARY') {
                detailsElements.forEach(otherDetails => {
                    if (otherDetails !== details) {
                        otherDetails.removeAttribute('open');
                    }
                });
            }
        });
    });
});

// Add the new functions for edit and delete
function deleteReference(type, id) {
    if (confirm('Are you sure you want to delete this reference?')) {
        fetch(`/delete_reference/${type}/${id}`, {
            method: 'POST',
        }).then(() => {
            window.location.reload();
        });
    }
}

function editReference(type, id) {
    // Clear the form first
    document.querySelector('#referenceForm').reset();
    
    // Find and open the correct details section based on type
    let detailsSection;
    if (type === 'doi') {
        detailsSection = document.querySelector('details summary[name="add_by_doi"]').parentElement;
    } else if (type === 'article') {
        detailsSection = document.querySelector('details summary[name="add_article"]').parentElement;
    } else if (type === 'book') {
        detailsSection = document.querySelector('details summary[name="add_book"]').parentElement;
    } else if (type === 'inproceeding') {
        detailsSection = document.querySelector('details summary[name="add_conference_paper"]').parentElement;
    }
    
    if (detailsSection) {
        // Close all other sections
        document.querySelectorAll('details').forEach(d => d.removeAttribute('open'));
        // Open the correct section
        detailsSection.setAttribute('open', '');
    }
    
    // Populate the form with existing data
    const reference = document.querySelector(`#reference-${type}-${id}`);
    if (reference) {
        if (type === 'doi') {
            document.querySelector('#doi').value = reference.dataset.doi;
        } else if (type === 'article') {
            document.querySelector('#article_author').value = reference.dataset.author;
            document.querySelector('#article_title').value = reference.dataset.title;
            document.querySelector('#article_journal').value = reference.dataset.journal;
            document.querySelector('#article_year').value = reference.dataset.year;
        } else if (type === 'book') {
            document.querySelector('#book_author').value = reference.dataset.author;
            document.querySelector('#book_title').value = reference.dataset.title;
            document.querySelector('#book_book_title').value = reference.dataset.bookTitle;
            document.querySelector('#book_publisher').value = reference.dataset.publisher;
            document.querySelector('#book_year').value = reference.dataset.year;
        } else if (type === 'inproceeding') {
            document.querySelector('#inproceeding_author').value = reference.dataset.author;
            document.querySelector('#inproceeding_title').value = reference.dataset.title;
            document.querySelector('#inproceeding_book_title').value = reference.dataset.bookTitle;
            document.querySelector('#inproceeding_year').value = reference.dataset.year;
        }
    }
    
    // Change form action to edit instead of create
    const form = document.querySelector('#referenceForm');
    form.action = `/edit_reference/${type}/${id}`;
}

</script>
{% endblock %}